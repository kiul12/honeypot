{% extends 'base.html' %}
{% block title %}可视化地图{% endblock %}
{% block header %}全球攻击分布地图{% endblock %}
{% block content %}
<div class="map-container">
    <div class="map-header">
        <h3>攻击来源国家分布</h3>
        <p>鼠标悬停查看详细信息</p>
    </div>
    <div id="world-map" style="width:100%;height:600px;border:1px solid #ddd;border-radius:8px;"></div>

    <div class="map-legend">
        <h4>图例</h4>
        <div class="legend-item">
            <span class="legend-color" style="background:#ff6b6b;"></span>
            <span>高攻击频率 (>100次)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background:#ffa726;"></span>
            <span>中攻击频率 (10-100次)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background:#66bb6a;"></span>
            <span>低攻击频率 (1-10次)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background:#e0e0e0;"></span>
            <span>无攻击记录</span>
        </div>
    </div>
</div>

<!-- 1. 引入 ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script>
    const attackData = {{ attacks_by_country | tojson }};
    const mapData = attackData.map(item => ({
        name: item.country || '未知',
        value: item.count
    }));

    const mapChart = echarts.init(document.getElementById('world-map'));

    const option = {
        title: { text: '全球攻击分布', left: 'center', textStyle: { color: '#333' } },
        tooltip: {
            trigger: 'item',
            formatter: p => p.data ? `${p.name}<br/>攻击次数: ${p.value}` : `${p.name}<br/>攻击次数: 0`
        },
        visualMap: {
            min: 0,
            max: Math.max(...mapData.map(d => d.value), 1),
            left: 'left',
            top: 'bottom',
            text: ['高', '低'],
            calculable: true,
            inRange: { color: ['#e0e0e0', '#ff6b6b'] }
        },
        series: [{
            name: '攻击次数',
            type: 'map',
            map: 'world',
            roam: true,
            emphasis: { label: { show: true } },
            data: mapData
        }]
    };

    /* 2. 加载世界地图 geoJSON */
    fetch('https://cdn.jsdelivr.net/npm/echarts@5.4.3/map/json/world.json')
        .then(res => res.json())
        .then(json => {
            echarts.registerMap('world', json);
            mapChart.setOption(option);
        })
        .catch(err => {
            console.error('地图数据加载失败:', err);
            mapChart.setOption({ title: { text: '地图加载失败', left: 'center' } });
        });

    window.addEventListener('resize', () => mapChart.resize());
</script>

<style>
.map-container{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);}
.map-header{text-align:center;margin-bottom:20px;}
.map-header h3{color:#333;margin-bottom:5px;}
.map-header p{color:#666;font-size:14px;}
.map-legend{margin-top:20px;padding:15px;background:#f8f9fa;border-radius:5px;}
.map-legend h4{margin-bottom:10px;color:#333;}
.legend-item{display:flex;align-items:center;margin-bottom:8px;}
.legend-color{width:20px;height:20px;border-radius:3px;margin-right:10px;display:inline-block;}
</style>
{% endblock %}