{% extends 'base.html' %}
{% block title %}ä»ªè¡¨ç›˜{% endblock %}
{% block header %}èœœç½ç®¡ç†ä»ªè¡¨ç›˜{% endblock %}
{% block content %}
<!-- ä¸å·¦å³æ™ƒåŠ¨å¤–å£³ -->
<div class="dash-wrapper">
  <div class="dash-grid">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stat-card"><h3>{{ total_attacks }}</h3><p>æ€»æ”»å‡»æ¬¡æ•°</p></div>
    <div class="stat-card"><h3>{{ unique_attackers }}</h3><p>æ”»å‡»è€…æ•°é‡</p></div>
    <div class="stat-card"><h3>{{ attack_types|length }}</h3><p>æ”»å‡»ç±»å‹</p></div>
    <div class="stat-card"><h3>{{ country_stats|length }}</h3><p>æ¶‰åŠå›½å®¶</p></div>

    <!-- æ“ä½œåŒº -->
    <div class="dash-card">
      <h4>å¿«æ·æ“ä½œ</h4>
      <form method="post" action="{{ url_for('admin.simulate_attack') }}" style="display:inline;">
        {{ csrf_token() }}
        <button type="submit" class="btn btn-success">ğŸ§ª æ¨¡æ‹Ÿæ”»å‡»</button>
      </form>
      <a href="{{ url_for('admin.export_stats') }}" class="btn btn-primary">ğŸ“Š å¯¼å‡ºæ•°æ®</a>
      <small class="update-time">æœ€æ–°æ›´æ–°ï¼š{{ latest_update.timestamp if latest_update else 'æ— æ•°æ®' }}</small>
    </div>

    <!-- Top æ’è¡Œ -->
    <div class="dash-card">
      <h4>ğŸ”¥ Top æ”»å‡»ç±»å‹</h4>
      <ol>
        {% for attack_type, count in attack_types[:3] %}
        <li>{{ attack_type or 'æœªçŸ¥' }}: {{ count }}æ¬¡</li>
        {% endfor %}
      </ol>
    </div>

    <div class="dash-card">
      <h4>ğŸŒ Top æ”»å‡»åœ°åŒº</h4>
      <ol>
        {% for country, count in country_stats[:3] %}
        <li>{{ country or 'æœªçŸ¥' }}: {{ count }}æ¬¡</li>
        {% endfor %}
      </ol>
    </div>

    <!-- å›¾è¡¨ -->
    <div class="dash-card full">
      <h4>æ”»å‡»ç±»å‹åˆ†å¸ƒ</h4>
      <div id="attack-types-chart" style="height:300px;"></div>
    </div>
    <div class="dash-card full">
      <h4>åœ°åŒºåˆ†å¸ƒ</h4>
      <div id="country-chart" style="height:300px;"></div>
    </div>

    <!-- æœ€è¿‘äº‹ä»¶ -->
    <div class="dash-card full">
      <h4>æœ€è¿‘æ”»å‡»äº‹ä»¶</h4>
      <table class="simple-table">
        <thead><tr><th>æ—¶é—´</th><th>IP</th><th>æ–¹æ³•</th><th>è·¯å¾„</th><th>çº§åˆ«</th></tr></thead>
        <tbody>
          {% for e in recent_attacks %}
          <tr>
            <td>{{ e.timestamp.strftime('%m-%d %H:%M') if e.timestamp else 'â€”' }}</td>
            <td>{{ e.ip_address }}</td>
            <td>{{ e.method }}</td>
            <td>{{ e.path[:30] + '...' if e.path and e.path|length > 30 else e.path or 'â€”' }}</td>
            <td><span class="severity-{{ e.severity or 'unknown' }}">{{ e.severity or 'â€”' }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ECharts å¼•ç”¨ä¸åˆå§‹åŒ– -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
const attackTypesData = {{ attack_types | tojson }};
const countryData = {{ country_stats | tojson }};
// æ”»å‡»ç±»å‹é¥¼å›¾
const typeChart = echarts.init(document.getElementById('attack-types-chart'));
typeChart.setOption({
  tooltip: {trigger:'item',formatter:'{b}: {c} ({d}%)'},
  series:[{type:'pie',radius:'50%',data:attackTypesData.map(i=>({value:i[1],name:i[0]||'æœªçŸ¥'}))}]
});
// åœ°åŒºæŸ±çŠ¶å›¾
const countryChart = echarts.init(document.getElementById('country-chart'));
countryChart.setOption({
  tooltip:{trigger:'axis'},
  xAxis:{type:'category',data:countryData.map(i=>i[0]||'æœªçŸ¥')},
  yAxis:{type:'value'},
  series:[{type:'bar',data:countryData.map(i=>i[1]),itemStyle:{color:'#667eea'}}]
});
window.addEventListener('resize',()=>{typeChart.resize();countryChart.resize();});
</script>

{% endblock %}